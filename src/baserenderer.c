#include "game.h"

struct mfb_window *window;

uint32_t framebuffer_size_x = 0;
uint32_t framebuffer_size_y = 0;
uint32_t next_framebuffer_size_x = 160;
uint32_t next_framebuffer_size_y = 160;
uint32_t actual_window_size_x = 0;
uint32_t actual_window_size_y = 0;

uint32_t *framebuffer = NULL;

int resize_window() {
    if (framebuffer_size_x == next_framebuffer_size_x && framebuffer_size_y == next_framebuffer_size_y) {
        return 0;
    }
    framebuffer = tracked_realloc(framebuffer, next_framebuffer_size_x * next_framebuffer_size_y * 4);

    framebuffer_size_x = next_framebuffer_size_x;
    framebuffer_size_y = next_framebuffer_size_y;
    return 0;
}

void update_size(struct mfb_window *window, int width, int height) {
    (void)window;
    actual_window_size_x = width;
    actual_window_size_y = height;
    next_framebuffer_size_x = (width * framebuffer_size_y) / height;
}

// In fixed point Q28:4
int32_t camera_position_x = 0;
int32_t camera_position_y = 0;
// Integer format
int32_t camera_position_z = 0;

uint32_t textures[256 * 256] = 
{
    0x0d5e21, 0x0d5e21, 0x139133, 0x25e255, 0x139133, 0x0d6423, 0x0d6423, 0x0d5e21, 0x0d6423, 0x0d5e21, 0x139133, 0x139133, 0x139133, 0x139133, 0x0d6423, 0x139133, 
  0x0d5e21, 0x139133, 0x0d6423, 0x0d5e21, 0x139133, 0x0d5e21, 0x0f7127, 0x0f7127, 0x17ae3e, 0x0d6423, 0x0d6423, 0x0f7127, 0x0f7127, 0x0f7127, 0x0d6423, 0x139133, 
  0x139133, 0x17ae3e, 0x25e255, 0x139133, 0x0d6423, 0x139133, 0x17ae3e, 0x25e255, 0x0f7127, 0x0f7127, 0x17ae3e, 0x0f7127, 0x0d6423, 0x0d6423, 0x139133, 0x17ae3e, 
  0x139133, 0x0d5e21, 0x0d5e21, 0x139133, 0x139133, 0x0d6423, 0x25e255, 0x0d6423, 0x139133, 0x0f7127, 0x0f7127, 0x17ae3e, 0x25e255, 0x17ae3e, 0x0d6423, 0x0d6423, 
  0x0d6423, 0x0f7127, 0x25e255, 0x0f7127, 0x0f7127, 0x0d6423, 0x0d6423, 0x25e255, 0x139133, 0x0f7127, 0x0d6423, 0x17ae3e, 0x139133, 0x139133, 0x0d6423, 0x139133, 
  0x25e255, 0x139133, 0x0f7127, 0x25e255, 0x139133, 0x0d5e21, 0x17ae3e, 0x0f7127, 0x0f7127, 0x0d6423, 0x0d6423, 0x0d6423, 0x0d6423, 0x0d6423, 0x17ae3e, 0x139133, 
  0x0f7127, 0x139133, 0x139133, 0x0f7127, 0x0d5e21, 0x17ae3e, 0x139133, 0x139133, 0x17ae3e, 0x0d6423, 0x0d6423, 0x25e255, 0x0d6423, 0x0d6423, 0x17ae3e, 0x0f7127, 
  0x25e255, 0x0d5e21, 0x139133, 0x25e255, 0x0d6423, 0x17ae3e, 0x139133, 0x0f7127, 0x25e255, 0x0d6423, 0x0d6423, 0x0d6423, 0x0d6423, 0x17ae3e, 0x139133, 0x139133, 
  0x0d6423, 0x0d6423, 0x25e255, 0x0f7127, 0x0d6423, 0x139133, 0x0f7127, 0x17ae3e, 0x17ae3e, 0x0d6423, 0x0d6423, 0x139133, 0x25e255, 0x139133, 0x25e255, 0x17ae3e, 
  0x0f7127, 0x139133, 0x17ae3e, 0x0f7127, 0x0f7127, 0x0d6423, 0x0d6423, 0x0d6423, 0x139133, 0x0d6423, 0x0f7127, 0x25e255, 0x17ae3e, 0x139133, 0x139133, 0x25e255, 
  0x25e255, 0x0d5e21, 0x0d5e21, 0x25e255, 0x0d5e21, 0x0d6423, 0x0d6423, 0x17ae3e, 0x0d6423, 0x0d6423, 0x25e255, 0x25e255, 0x25e255, 0x0d6423, 0x25e255, 0x17ae3e, 
  0x0d5e21, 0x25e255, 0x0d6423, 0x0d6423, 0x0d5e21, 0x139133, 0x25e255, 0x17ae3e, 0x0d6423, 0x0d6423, 0x139133, 0x0f7127, 0x17ae3e, 0x0d6423, 0x25e255, 0x25e255, 
  0x0d5e21, 0x139133, 0x17ae3e, 0x17ae3e, 0x139133, 0x17ae3e, 0x17ae3e, 0x0d6423, 0x139133, 0x0d5e21, 0x139133, 0x17ae3e, 0x0f7127, 0x139133, 0x0f7127, 0x0d6423, 
  0x0d5e21, 0x139133, 0x17ae3e, 0x25e255, 0x0d6423, 0x0d6423, 0x17ae3e, 0x0d6423, 0x0d5e21, 0x0d6423, 0x0d5e21, 0x149c36, 0x0f7127, 0x17ae3e, 0x17ae3e, 0x0d6423, 
  0x25e255, 0x0f7127, 0x149c36, 0x139133, 0x0f7127, 0x0d6423, 0x0d6423, 0x0d6423, 0x0d5e21, 0x149c36, 0x17ae3e, 0x149c36, 0x139133, 0x0f7127, 0x0d6423, 0x0d6423, 
  0x0f7127, 0x149c36, 0x0f7127, 0x139133, 0x0f7127, 0x0f7127, 0x139133, 0x0d6423, 0x149c36, 0x139133, 0x0d6423, 0x0f7127, 0x17ae3e, 0x17ae3e, 0x0d5e21, 0x0d5e21,
    0xab6a47, 0x885437, 0xab6a47, 0xab6a47, 0x885437, 0xab6a47, 0xab6a47, 0x744730, 0xab6a47, 0x885437, 0xab6a47, 0x885437, 0xab6a47, 0x825237, 0xab6a47, 0x885437, 
  0x955c3e, 0x885437, 0xab6a47, 0xab6a47, 0x744730, 0xd2a891, 0xab6a47, 0xc28869, 0xab6a47, 0xbb7d5b, 0x885437, 0xab6a47, 0x744730, 0xab6a47, 0xc28869, 0xab6b49, 
  0xab6a47, 0xab6a47, 0x7f7f7f, 0xbb7d5b, 0xc28869, 0xb16d49, 0xab6a47, 0xb16d49, 0xab6a47, 0x744730, 0x955c3e, 0x7f7f7f, 0xab6a47, 0xab6a47, 0x744730, 0xab6a47, 
  0xbb7d5b, 0xab6a47, 0xab6a47, 0x955c3e, 0xab6a47, 0xab6a47, 0xab6a47, 0x744730, 0x7f7f7f, 0x885437, 0xab6a47, 0x744730, 0xab6a47, 0x825237, 0xab6a47, 0x885437, 
  0x955c3e, 0xab6a47, 0x955c3e, 0xab6a47, 0xab6a47, 0xbb7d5b, 0x955c3e, 0xab6a47, 0xab6a47, 0xab6a47, 0x744730, 0xac6a46, 0xab6a47, 0xab6a47, 0x744730, 0xab6a47, 
  0xc28869, 0xab6a47, 0x825237, 0x825237, 0x7f7f7f, 0xd2a891, 0xab6a47, 0xac6a46, 0xbb7d5b, 0x955c3e, 0xc28869, 0xab6a47, 0xab6a47, 0xab6a47, 0xc28869, 0xab6a47, 
  0xab6a47, 0xab6a47, 0x955c3e, 0xab6a47, 0xab6a47, 0xab6a47, 0x70452e, 0x955c3e, 0x744730, 0xab6a47, 0xab6a47, 0xab6a47, 0x825237, 0x955c3e, 0x885437, 0x885437, 
  0xab6a47, 0xab6a47, 0xd2a891, 0x744730, 0xab6a47, 0xc28869, 0xab6a47, 0x7f7f7f, 0xc28869, 0xc28869, 0xab6a47, 0xd2a891, 0x885437, 0x744730, 0x744730, 0xab6a47, 
  0xab6a47, 0x955c3e, 0xab6a47, 0xc28869, 0xab6a47, 0xab6a47, 0xab6a47, 0xab6b49, 0xab6a47, 0xab6a47, 0xab6a47, 0x825237, 0x744730, 0xab6a47, 0xab6a47, 0xab6a47, 
  0x744730, 0xab6a47, 0xac6a46, 0x70452e, 0xab6a47, 0xc28869, 0x955c3e, 0x744730, 0xd2a891, 0x744730, 0x744730, 0x885437, 0xbb7d5b, 0xc28869, 0xbb7d5b, 0x744730, 
  0x744730, 0xab6a47, 0xab6a47, 0x7f7f7f, 0xab6a47, 0x825237, 0xab6b49, 0xac6a46, 0xab6a47, 0xab6a47, 0xab6a47, 0xab6a47, 0xab6a47, 0xab6a47, 0xab6a47, 0x744730, 
  0xab6a47, 0xab6a47, 0xab6a47, 0x825237, 0x744730, 0xab6b49, 0xab6a47, 0xab6a47, 0xab6a47, 0xbb7d5b, 0xd2a891, 0x744730, 0xab6a47, 0xac6a46, 0x744730, 0xab6a47, 
  0x885437, 0x825237, 0xab6a47, 0xab6a47, 0x885437, 0xab6a47, 0x744730, 0x7f7f7f, 0xc28869, 0xab6a47, 0x825237, 0x825237, 0xc28869, 0xab6a47, 0xab6a47, 0xab6a47, 
  0xab6a47, 0xab6a47, 0xc28869, 0xab6a47, 0x955c3e, 0xab6a47, 0x825237, 0xab6a47, 0xab6a47, 0xab6a47, 0x825237, 0xab6a47, 0xab6a47, 0x825237, 0xab6a47, 0x955c3e, 
  0xab6a47, 0xab6a47, 0x885437, 0xab6a47, 0xab6a47, 0xbb7d5b, 0xab6a47, 0xab6a47, 0x885437, 0x825237, 0xab6a47, 0xab6a47, 0xbb7d5b, 0xab6a47, 0xab6a47, 0xab6a47, 
  0x885437, 0xbb7d5b, 0x885437, 0xab6a47, 0x885437, 0xab6a47, 0x744730, 0xab6a47, 0xab6a47, 0xab6a47, 0x885437, 0xab6a47, 0xab6a47, 0x885437, 0xab6a47, 0xab6a47
};

void draw_chunk(int32_t cx, int32_t cy) {
    uint32_t chunk_index = get_chunk(cx, cy);
    if (chunk_index == NULL_CHUNK) {
        return;
    }
    uint16_t *chunk = &chunk_array[chunk_index * CHUNK_SIZE * CHUNK_SIZE];

    // Convert chunk position to screen space
    int32_t chunk_screen_x = cx * CHUNK_SIZE * TILE_SIZE - camera_position_x;
    int32_t chunk_screen_y = cy * CHUNK_SIZE * TILE_SIZE - camera_position_y;

    int32_t chunk_screen_x_end = chunk_screen_x + CHUNK_SIZE * TILE_SIZE;
    int32_t chunk_screen_y_end = chunk_screen_y + CHUNK_SIZE * TILE_SIZE;

    // Clamp drawing to screen
    int32_t screen_start_x = MAX(chunk_screen_x, 0);
    int32_t screen_start_y = MAX(chunk_screen_y, 0);
    int32_t screen_end_x   = MIN(chunk_screen_x_end, (int32_t)framebuffer_size_x);
    int32_t screen_end_y   = MIN(chunk_screen_y_end, (int32_t)framebuffer_size_y);

    // Corresponding start in chunk pixel coordinates
    int32_t chunk_start_px = screen_start_x - chunk_screen_x;
    int32_t chunk_start_py = screen_start_y - chunk_screen_y;

    // Copy pixels to the screen (with cropping optimization).
    for (int32_t sy = screen_start_y, cpy = chunk_start_py; sy < screen_end_y; sy++, cpy++) {
        for (int32_t sx = screen_start_x, cpx = chunk_start_px; sx < screen_end_x; sx++, cpx++) {

            int32_t tile_x = cpx / TILE_SIZE;
            int32_t tile_y = cpy / TILE_SIZE;

            uint16_t tile_id = chunk[tile_y * CHUNK_SIZE + tile_x];

            int32_t pixel_offset_x = cpx & TILE_MASK;
            int32_t pixel_offset_y = cpy & TILE_MASK;

            framebuffer[sx + sy * framebuffer_size_x] =
                textures[
                    tile_id * TILE_SIZE * TILE_SIZE +
                    pixel_offset_y * TILE_SIZE +
                    pixel_offset_x
                ];
        }
    }

}